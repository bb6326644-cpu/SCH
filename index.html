<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç‰¹æ•™ç³»å¤œé–“è„«é€ƒï½œå¯†å®¤é€ƒè„«ï¼ˆæ‰‹æ©Ÿç‰ˆèµ°è·¯ç‰ˆï¼‹ä¿¡å°ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f3f7ff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #222;
    }

    .game-container {
      background: #fff;
      width: 95%;
      max-width: 960px;
      padding: 16px 16px 20px;
      border-radius: 18px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.08);
    }

    h1 {
      margin: 0;
      font-size: 1.4rem;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      font-size: .9rem;
      color: #555;
      margin: 4px 0 12px;
    }

    .top-info {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: space-between;
      font-size: .85rem;
      margin-bottom: 10px;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      background: #eef2ff;
      color: #334;
    }

    #timer {
      font-weight: 600;
      color: #c0392b;
    }

    .map-wrapper {
      position: relative;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid #d0d7f7;
      background: #f0d3a5;
      aspect-ratio: 4/3;
    }

    .scene {
      position: absolute;
      inset: 0;
      display: none;
    }

    .scene.active { display: block; }

    .scene-inner {
      position: absolute;
      inset: 7%;
      background: #f4d7aa;
      border-radius: 16px;
      box-shadow:
        inset 0 0 0 3px rgba(157,109,56,0.35),
        inset 0 14px 0 rgba(255,255,255,0.4);
    }

    .door {
      position: absolute;
      width: 18%;
      height: 16%;
      bottom: 0;
      left: 41%;
      background: #d59b61;
      border-radius: 10px 10px 0 0;
      box-shadow: 0 -4px 0 rgba(0,0,0,0.2);
    }
    .door::after {
      content: "";
      position: absolute;
      right: 12%;
      top: 40%;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #8b5a2b;
    }

    .marker {
      position: absolute;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: #ff3b30;
      color: #fff;
      font-weight: 800;
      cursor: default;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: translate(-50%, -50%);
      box-shadow: 0 2px 6px rgba(0,0,0,0.28);
      font-size: 1.1rem;
    }

    .marker.done {
      background: #4cd964;
      opacity: 0.85;
    }

    .player {
      position: absolute;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #3498db;
      border: 3px solid #ffffff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transform: translate(-50%, -50%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      color: #fff;
      z-index: 5;
    }

    /* 0. å¤§å»³ */
    .scene-lobby .desk {
      position: absolute;
      width: 32%;
      height: 18%;
      top: 35%;
      left: 50%;
      transform: translateX(-50%);
      background: #c77a3a;
      border-radius: 10px;
      box-shadow: 0 4px 0 rgba(0,0,0,0.2);
    }
    .scene-lobby .desk::before {
      content: "";
      position: absolute;
      width: 40%;
      height: 40%;
      top: 15%;
      left: 30%;
      background: #fefcf1;
      border-radius: 6px;
      box-shadow:
        0 0 0 2px rgba(0,0,0,0.1),
        8px 6px 0 0 rgba(199,122,58,0.5);
    }
    .scene-lobby .notice {
      position: absolute;
      top: 11%;
      left: 50%;
      transform: translateX(-50%);
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.9);
      font-size: .8rem;
      color: #555;
      box-shadow: 0 2px 4px rgba(0,0,0,0.12);
    }

    /* 1. æ•™å®¤ A */
    .scene-classA .board {
      position: absolute;
      top: 7%;
      left: 8%;
      width: 84%;
      height: 15%;
      background: #356b48;
      border-radius: 8px;
      box-shadow: inset 0 0 0 3px #263e2e;
    }
    .scene-classA .teacher-desk {
      position: absolute;
      top: 32%;
      left: 34%;
      width: 32%;
      height: 16%;
      background: #c77a3a;
      border-radius: 10px;
      box-shadow: 0 4px 0 rgba(0,0,0,0.2);
    }
    .scene-classA .book-row {
      position: absolute;
      bottom: 16%;
      left: 10%;
      right: 10%;
      height: 26%;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }
    .scene-classA .book {
      width: 18%;
      height: 70%;
      background: #f7d98b;
      border-radius: 4px;
      box-shadow: 0 3px 0 rgba(0,0,0,0.2);
      position: relative;
    }
    .scene-classA .book:nth-child(1){background:#f6c15b;}
    .scene-classA .book:nth-child(2){background:#f48b6a;}
    .scene-classA .book:nth-child(3){background:#7ec4e0;}
    .scene-classA .book:nth-child(4){background:#9ad07d;}
    .scene-classA .book::after{
      content:"";
      position:absolute;
      left:15%;
      right:15%;
      top:20%;
      bottom:25%;
      border-radius:3px;
      border:2px solid rgba(255,255,255,0.7);
    }

    /* 2. æ•™å®¤ Bï¼šäº®æš—ç‡ˆè™Ÿ */
    .scene-classB .board {
      position: absolute;
      top: 9%;
      left: 10%;
      width: 80%;
      height: 14%;
      background: #2f4e7a;
      border-radius: 10px;
      box-shadow: inset 0 0 0 3px #1f3550;
    }
    .scene-classB .lamp-row {
      position: absolute;
      top: 40%;
      left: 18%;
      width: 64%;
      height: 12%;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .lamp {
      width: 22%;
      height: 70%;
      border-radius: 999px;
      background: #999;
      box-shadow: inset 0 0 0 3px rgba(0,0,0,0.25);
      position: relative;
    }
    .lamp::after{
      content:"";
      position:absolute;
      inset:14%;
      border-radius:999px;
      background: #222;
    }
    .lamp.on::after{
      background:#ffe55b;
      box-shadow:0 0 10px rgba(255,229,91,0.8);
    }

    /* 3. æ•™å®¤ Cï¼šé«”è‚²å„²ç‰©æ«ƒ */
    .scene-classC .cabinet {
      position: absolute;
      left: 10%;
      top: 20%;
      width: 30%;
      height: 50%;
      background: #f3c85b;
      border-radius: 8px;
      box-shadow: 0 4px 0 rgba(0,0,0,0.2);
    }
    .scene-classC .cabinet::before {
      content:"";
      position:absolute;
      left:50%;
      top:10%;
      bottom:10%;
      width:2px;
      background:#d49c3b;
    }
    .scene-classC .ball {
      position:absolute;
      width:18%;
      padding-bottom:18%;
      border-radius:50%;
      background:#e47356;
      box-shadow:0 3px 0 rgba(0,0,0,0.2);
    }
    .scene-classC .ball:nth-child(1){left:52%;top:36%;}
    .scene-classC .ball:nth-child(2){left:67%;top:55%;background:#6bb5e3;}
    .scene-classC .ball:nth-child(3){left:77%;top:36%;background:#8bcf7f;}

    /* 4. è¾¦å…¬å®¤ï¼šæœ€çµ‚å¯†ç¢¼ç®± */
    .scene-office .desk {
      position: absolute;
      top: 38%;
      left: 28%;
      width: 44%;
      height: 20%;
      background: #c77a3a;
      border-radius: 10px;
      box-shadow: 0 4px 0 rgba(0,0,0,0.2);
    }
    .scene-office .safe {
      position:absolute;
      top:18%;
      left:30%;
      width:40%;
      height:60%;
      background:#e0e4f5;
      border-radius:8px;
      box-shadow:
        0 3px 0 rgba(0,0,0,0.25),
        inset 0 0 0 3px #9aa3ce;
    }
    .scene-office .safe::before {
      content:"";
      position:absolute;
      left:14%;
      right:48%;
      top:28%;
      bottom:28%;
      border-radius:6px;
      border:3px solid #9aa3ce;
    }
    .scene-office .safe::after {
      content:"";
      position:absolute;
      right:16%;
      top:32%;
      width:22%;
      height:36%;
      border-radius:50%;
      border:4px solid #9aa3ce;
    }

    .status-text {
      font-size: .85rem;
      margin-top: 6px;
      color: #444;
    }
    .status-text span {
      font-weight: 600;
      color: #355dff;
    }

    .success-banner {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #e3f7e8;
      font-size: .9rem;
      color: #2d7a43;
      display: none;
    }
    .success-banner.show { display: block; }

    .success-banner p {
      margin: 0 0 4px;
      line-height: 1.5;
    }

    .success-actions {
      margin-top: 6px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .controls {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .controls-info {
      font-size: .8rem;
      color: #555;
      text-align: center;
    }

    .controls-grid {
      display: inline-flex;
      flex-direction: column;
      gap: 4px;
    }

    .controls-row {
      display: flex;
      justify-content: center;
      gap: 8px;
    }

    .ctrl-btn {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      border: none;
      background: #eef2ff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform .08s ease, box-shadow .08s ease, background .08s ease;
    }

    .ctrl-btn:active {
      transform: translateY(1px) scale(0.97);
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      background: #dce3ff;
    }

    /* ===== ä¿¡å°å‹•ç•« Overlay ===== */
    .envelope-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 950;
      padding: 16px;
    }
    .envelope-overlay.active {
      display: flex;
      animation: fadeIn .2s ease-out;
    }

    .envelope-card {
      position: relative;
      width: 240px;
      height: 160px;
      cursor: pointer;
      transform-origin: center;
      animation: popIn .25s ease-out;
    }

    .envelope-body {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 70%;
      background: #fefaf2;
      border-radius: 0 0 14px 14px;
      border: 2px solid #e0c9a5;
      border-top: none;
      box-shadow: 0 6px 14px rgba(0,0,0,0.25);
    }

    .envelope-flap {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 70%;
      background: linear-gradient(135deg,#f3d2a2 0%,#f6e0b8 50%,#f3d2a2 100%);
      clip-path: polygon(0 0, 100% 0, 50% 72%);
      border-radius: 14px 14px 0 0;
      border: 2px solid #e0c9a5;
      border-bottom: none;
    }

    .envelope-inner {
      position: absolute;
      inset: 24% 14% 18% 14%;
      background: #ffffff;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 8px 10px;
      font-size: .8rem;
      color: #444;
    }

    .envelope-inner p {
      margin: 0;
      line-height: 1.4;
    }

    .envelope-btn {
      align-self: flex-end;
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      background: #355dff;
      color: #fff;
      font-size: .8rem;
      cursor: pointer;
    }

    @keyframes popIn {
      from { transform: scale(0.6); opacity: 0; }
      to   { transform: scale(1);   opacity: 1; }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }

    /* ===== é¡Œç›® Modal ===== */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 12px;
      z-index: 1000;
    }
    .modal-backdrop.active { display: flex; }

    .modal {
      background: #fff;
      width: 100%;
      max-width: 520px;
      border-radius: 16px;
      padding: 16px 18px 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.3);
      max-height: 90vh;
      overflow: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .modal-title {
      font-size: 1rem;
      font-weight: 600;
    }
    .modal-close {
      border: none;
      background: transparent;
      font-size: 1.4rem;
      cursor: pointer;
      line-height: 1;
      padding: 0 4px;
    }
    .question-text {
      font-size: .96rem;
      line-height: 1.6;
      margin-bottom: 10px;
    }
    .hint-text {
      font-size: .84rem;
      color: #666;
      margin-bottom: 8px;
    }
    .answer-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #cfd6f5;
      font-size: .95rem;
      margin-bottom: 8px;
    }
    .feedback {
      font-size: .86rem;
      line-height: 1.5;
      padding: 6px 8px;
      border-radius: 8px;
      background: #f6f7ff;
      border: 1px dashed #cfd3f7;
      margin-bottom: 8px;
      min-height: 40px;
    }
    .feedback.correct-text { color: #2d7a43; }
    .feedback.wrong-text   { color: #b02a2a; }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }
    .btn {
      border-radius: 999px;
      padding: 7px 14px;
      border: none;
      cursor: pointer;
      font-size: .88rem;
      font-weight: 500;
    }
    .btn-primary {
      background: #355dff;
      color: #fff;
    }
    .btn-secondary {
      background: #e5e7f5;
      color: #333;
    }
    .btn[disabled] {
      opacity: .7;
      cursor: default;
    }

    @media (max-width: 600px) {
      .game-container { padding: 12px 10px 14px; }
      h1 { font-size: 1.25rem; }
      .top-info { flex-direction: column; align-items: flex-start; gap: 4px; }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <h1>ç‰¹æ•™ç³»å¤œé–“è„«é€ƒï¼šå¯†å®¤é€ƒè„«ï¼ˆèµ°è·¯ï¼‹ä¿¡å°ç‰ˆï¼‰</h1>
    <p class="subtitle">
      æ™šä¸Šä½ å€‘è¢«åé–åœ¨ç‰¹æ•™ç³»ç³»é¤¨è£¡ï¼Œåªèƒ½é èµ°åˆ°ç´…è‰²é©šå˜†è™Ÿæ”¶é›†ä¿¡å°ç·šç´¢ï¼Œ
      è§£å‡ºç‰¹æ•™èˆ‡èº«å¿ƒéšœç¤™ç›¸é—œçš„è¬é¡Œï¼Œæ‹¼å‡ºå¤§é–€å¯†ç¢¼ï¼Œæ‰èƒ½é€ƒå‡ºç³»é¤¨ï¼
    </p>

    <div class="top-info">
      <div class="badge">ç›®å‰ä½ç½®ï¼š<span id="locationLabel">å¤§å»³</span></div>
      <div class="badge">å·²å–å¾—å¯†ç¢¼ï¼š<span id="codesText">å°šæœªå–å¾—</span></div>
      <div class="badge">å‰©é¤˜æ™‚é–“ï¼š<span id="timer">15:00</span></div>
    </div>

    <div class="map-wrapper" id="mapWrapper">
      <!-- 0. å¤§å»³ -->
      <div class="scene scene-lobby active" data-scene="0">
        <div class="scene-inner">
          <div class="door"></div>
          <div class="desk"></div>
          <div class="notice">ç‰¹æ•™ç³»å¤§å»³ï½œç¬¬ä¸€å°é—œæ–¼å¤§é–€çš„ç·šç´¢åœ¨é€™è£¡</div>
          <button class="marker" data-scene="0" style="top:40%;left:50%;">!</button>
          <div class="player" id="player">æˆ‘</div>
        </div>
      </div>

      <!-- 1. æ•™å®¤ A -->
      <div class="scene scene-classA" data-scene="1">
        <div class="scene-inner">
          <div class="board"></div>
          <div class="teacher-desk"></div>
          <div class="book-row">
            <div class="book"></div>
            <div class="book"></div>
            <div class="book"></div>
            <div class="book"></div>
          </div>
          <div class="door"></div>
          <button class="marker" data-scene="1" style="top:47%;left:50%;">!</button>
        </div>
      </div>

      <!-- 2. æ•™å®¤ B -->
      <div class="scene scene-classB" data-scene="2">
        <div class="scene-inner">
          <div class="board"></div>
          <div class="lamp-row">
            <div class="lamp on"></div>
            <div class="lamp"></div>
            <div class="lamp on"></div>
          </div>
          <div class="door"></div>
          <button class="marker" data-scene="2" style="top:52%;left:50%;">!</button>
        </div>
      </div>

      <!-- 3. æ•™å®¤ C -->
      <div class="scene scene-classC" data-scene="3">
        <div class="scene-inner">
          <div class="cabinet"></div>
          <div class="ball"></div>
          <div class="ball"></div>
          <div class="ball"></div>
          <div class="door"></div>
          <button class="marker" data-scene="3" style="top:52%;left:30%;">!</button>
        </div>
      </div>

      <!-- 4. è¾¦å…¬å®¤ -->
      <div class="scene scene-office" data-scene="4">
        <div class="scene-inner">
          <div class="desk"></div>
          <div class="safe"></div>
          <div class="door"></div>
          <button class="marker" data-scene="4" style="top:52%;left:50%;">!</button>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="controls-info">
        ç”¨ä¸‹æ–¹æ–¹å‘éµç§»å‹•è—è‰²å°äººç‰©ï¼Œèµ°åˆ°ç´…è‰²é©šå˜†è™Ÿé™„è¿‘æ™‚æœƒå…ˆæ”¶åˆ°ã€Œä¿¡å°ã€ï¼Œé»ä¿¡å°æ‰“é–‹å¾Œæ‰æœƒçœ‹åˆ°è¬é¡Œã€‚
      </div>
      <div class="controls-grid">
        <div class="controls-row">
          <button class="ctrl-btn" data-dir="up">â–²</button>
        </div>
        <div class="controls-row">
          <button class="ctrl-btn" data-dir="left">â—€</button>
          <button class="ctrl-btn" data-dir="down">â–¼</button>
          <button class="ctrl-btn" data-dir="right">â–¶</button>
        </div>
      </div>
    </div>

    <p class="status-text">
      å°æç¤ºï¼šæ¯å€‹å ´æ™¯ä¸­çš„ <span>ç´…è‰²é©šå˜†è™Ÿ â—</span> éƒ½ä»£è¡¨ä¸€å€‹ç·šç´¢é»ï¼Œ
      å…ˆæ”¶åˆ°ä¿¡å°å†è§£é¡Œï¼Œæ‰èƒ½ä¸€æ­¥æ­¥é›†é½Šå¤§é–€å¯†ç¢¼ã€‚
    </p>

    <div id="successBanner" class="success-banner">
      <p>ğŸ‰ æ­å–œä½ åœ¨æ™‚é™å…§é›†é½Šå¤§é–€å¯†ç¢¼ï¼ŒæˆåŠŸæ‰“é–‹ç‰¹æ•™ç³»ç³»é¤¨çš„å¤§é–€ï¼</p>
      <p>
        åœ¨é€™æ®µé€ƒè„«æ—…ç¨‹ä¸­ï¼Œä½ ç·´ç¿’äº†ç«™åœ¨èº«å¿ƒéšœç¤™å­¸ç”Ÿçš„è§’åº¦æ€è€ƒï¼š
        äº†è§£éœ€æ±‚ã€èª¿æ•´æ•™å­¸èˆ‡ç’°å¢ƒã€åœ¨æ´»å‹•ä¸­åšåˆç†æ”¹è®Šã€‚
        æœªä¾†åœ¨çœŸå¯¦æ•™å®¤è£¡ï¼Œä¹Ÿåˆ¥å¿˜äº†ç”¨åŒæ¨£çš„é—œæ‡·èˆ‡é«”è«’é™ªä¼´æ¯ä¸€ä½å­¸ç”Ÿã€‚
      </p>
      <div class="success-actions">
        <button class="btn btn-secondary" id="stayBtn">å¾…åœ¨åŸåœ°</button>
        <button class="btn btn-primary" id="restartBtn">é‡æ–°æŒ‘æˆ°ä¸€æ¬¡</button>
      </div>
    </div>
  </div>

  <!-- ä¿¡å° Overlay -->
  <div class="envelope-overlay" id="envelopeOverlay" aria-hidden="true">
    <div class="envelope-card" id="envelopeCard">
      <div class="envelope-body"></div>
      <div class="envelope-flap"></div>
      <div class="envelope-inner">
        <p>ä½ åœ¨é€™è£¡ç™¼ç¾äº†ä¸€å°ç¥ç¥•çš„ç·šç´¢ä¿¡ä»¶ï¼Œè£¡é¢å¥½åƒè—è‘—ç‰¹æ•™ç³»å¤§é–€å¯†ç¢¼çš„ä¸€éƒ¨åˆ†ã€‚</p>
        <button class="envelope-btn" id="openLetterBtn">æ‰“é–‹ä¿¡ä»¶</button>
      </div>
    </div>
  </div>

  <!-- é¡Œç›® Modal -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">é—œå¡é¡Œç›®</div>
        <button class="modal-close" id="modalCloseBtn" aria-label="é—œé–‰è¦–çª—">Ã—</button>
      </div>
      <div class="question-text" id="questionText"></div>
      <div class="hint-text" id="hintText"></div>
      <input type="text" id="answerInput" class="answer-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥ç­”æ¡ˆï¼ˆæ•¸å­—æˆ–æ–‡å­—ï¼‰" />
      <div class="feedback" id="feedbackBox">è«‹ä»”ç´°é–±è®€é¡Œç›®ï¼Œå†è¼¸å…¥ä½ çš„ç­”æ¡ˆã€‚</div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelBtn">å…ˆé—œé–‰ï¼Œç­‰ç­‰å†æƒ³</button>
        <button class="btn btn-primary" id="submitBtn">æäº¤ç­”æ¡ˆ</button>
        <button class="btn btn-primary" id="nextSceneBtn" style="display:none;">å‰å¾€ä¸‹ä¸€å€‹å ´æ™¯ â–¶</button>
      </div>
    </div>
  </div>

  <script>
    // ===== é¡Œç›®è³‡æ–™ï¼ˆæ•¸å­—èˆ‡æ¦‚å¿µéƒ½ä¿ç•™ï¼Œæ”¹æˆå¤§é–€å¯†ç¢¼åŠ‡æƒ…ï¼‰ =====
    const scenesData = [
      {
        id: 0,
        name: "å¤§å»³",
        type: "info",
        title: "ç‰¹æ•™ç³»å¤§å»³ï¼šè¢«åé–çš„å¤œæ™š",
        question:
          "ä»Šæ™šä½ å€‘åœ¨ç‰¹æ•™ç³»ç³»é¤¨åƒåŠ æ´»å‹•ï¼Œä¸€ä¸å°å¿ƒå¾…åˆ°å¾ˆæ™šã€‚æº–å‚™é›¢é–‹æ™‚ï¼Œç™¼ç¾å¤§é–€å·²ç¶“è‡ªå‹•ä¸Šé–ï¼Œåªå‰©ä¸‹æœå‹™å°æ¡Œä¸Šä¸€å°ä¿¡ã€‚\n\nä¿¡å°è£¡å¯«è‘—ï¼š\nã€Œæƒ³æ‰“é–‹ç‰¹æ•™ç³»çš„å¤§é–€ï¼Œå°±å¾ã€çŸ¥è­˜çš„æˆ¿é–“ã€é–‹å§‹å§ã€‚ã€\n\nä½ å€‘å¿…é ˆåœ¨ 15 åˆ†é˜å…§èµ°éä¸åŒæ•™å®¤ï¼Œè§£é–‹ç‰¹æ•™èˆ‡èº«å¿ƒéšœç¤™ç›¸é—œçš„è¬é¡Œï¼Œæ”¶é›†å¤§é–€å¯†ç¢¼ã€‚æº–å‚™å¥½å°±å¯ä»¥å‰å¾€ç¬¬ä¸€é–“æ•™å®¤ã€‚",
        hint: "æç¤ºï¼šã€ŒçŸ¥è­˜çš„æˆ¿é–“ã€é€šå¸¸æ˜¯æ”¾æ»¿æ›¸æœ¬ã€å¸¸ç”¨ä¾†ä¸Šèª²ã€é–±è®€çš„æ•™å®¤ã€‚",
        answer: "",
        explanation:
          "é€™ä¸€é—œåªæ˜¯æ•…äº‹é–‹å ´ï¼Œé‚„æ²’æœ‰æ•¸å­—å¯†ç¢¼ã€‚ç•¶å¤§å®¶äº†è§£æƒ…å¢ƒå¾Œï¼Œå°±å¯ä»¥å‰å¾€æ•™å®¤ Aï¼Œé–‹å§‹è’é›†å¤§é–€å¯†ç¢¼ï¼ŒåŒæ™‚ç·´ç¿’ç‰¹æ•™èˆ‡èº«å¿ƒéšœç¤™ç›¸é—œçš„æ¦‚å¿µã€‚"
      },
      {
        id: 1,
        name: "æ•™å®¤ Aï¼ˆç‰¹æ•™æ ¸å¿ƒæ­¥é©Ÿï¼‰",
        type: "code",
        title: "æ•™å®¤ Aï¼šç‰¹æ•™ç³»å­¸ç”Ÿçš„å·¥ä½œæµç¨‹å¯†ç¢¼",
        question:
          "æ•™å®¤ A æ˜¯å¹³å¸¸ä¸Šã€Œç‰¹æ®Šæ•™è‚²æ¦‚è«–ã€èˆ‡ã€ŒIEP è¨­è¨ˆã€çš„åœ°æ–¹ï¼Œè¬›æ¡Œä¸Šæœ‰å››å€‹æŠ½å±œï¼ŒæŠ½å±œæ¨™ç±¤èˆ‡è²¼ç´™ä¸Šçš„æ•¸å­—å¦‚ä¸‹ï¼ˆæ³¨æ„ï¼šæŠ½å±œæ’åˆ—é †åºä¸ç­‰æ–¼å¯¦å‹™æµç¨‹é †åºï¼‰ï¼š\n\nâ‘  æŠ½å±œä¸€ï¼šå®¶é•·èˆ‡è·¨å°ˆæ¥­åœ˜éšŠåˆä½œæœƒè­°ã€€â†’ è²¼ç´™æ•¸å­— 7\nâ‘¡ æŠ½å±œäºŒï¼šå¯¦æ–½æ•™å­¸èª¿æ•´èˆ‡è¼”å…·æ”¯æ´ã€€ã€€â†’ è²¼ç´™æ•¸å­— 4\nâ‘¢ æŠ½å±œä¸‰ï¼šåŠŸèƒ½æ€§è©•é‡èˆ‡éœ€æ±‚äº†è§£ã€€ã€€ã€€â†’ è²¼ç´™æ•¸å­— 3\nâ‘£ æŠ½å±œå››ï¼šæ’°å¯«å€‹åˆ¥åŒ–æ•™è‚²è¨ˆç•« IEPã€€ã€€â†’ è²¼ç´™æ•¸å­— 1\n\næ¡Œä¸Šä¾¿æ¢ç´™å¯«è‘—ï¼š\nã€Œè«‹ä¸è¦è¢«æŠ½å±œç›®å‰çš„é †åºé¨™äº†ï¼Œ\nã€€å…ˆæƒ³å‡ºã€å¯¦å‹™ä¸Šæ¯”è¼ƒå¸¸è¦‹çš„æµç¨‹é †åºã€ï¼Œ\nã€€å†ä¾ç…§é‚£å€‹æµç¨‹å»è®€å‡ºå°æ‡‰æŠ½å±œä¸Šçš„æ•¸å­—ï¼Œ\nã€€æŠŠå››å€‹æ•¸å­—æ¥åœ¨ä¸€èµ·ï¼Œç•¶ä½œå¤§é–€å¯†ç¢¼çš„ä¸€éƒ¨åˆ†ã€‚ã€\n\nè«‹è¼¸å…¥ä½ æ¨ç†å‡ºçš„å››ä½æ•¸å¯†ç¢¼ã€‚",
        hint:
          "å¯¦å‹™ä¸Šé€šå¸¸æ˜¯ï¼šå…ˆäº†è§£å­¸ç”Ÿéœ€æ±‚èˆ‡åšè©•é‡ï¼Œå†æ’°å¯« IEPï¼Œç„¶å¾Œä¾è¨ˆç•«é€²è¡Œæ•™å­¸èª¿æ•´èˆ‡è¼”å…·æ”¯æ´ï¼Œæœ€å¾Œé€éå®¶é•·èˆ‡è·¨å°ˆæ¥­åœ˜éšŠæŒçºŒåˆä½œè¿½è¹¤ã€‚",
        answer: "3147",
        explanation:
          "é¡Œç›®çµ¦çš„æŠ½å±œé †åºæ˜¯ï¼š\næŠ½å±œä¸€ï¼šåˆä½œæœƒè­°(7)ã€æŠ½å±œäºŒï¼šæ•™å­¸èª¿æ•´(4)ã€æŠ½å±œä¸‰ï¼šè©•é‡éœ€æ±‚(3)ã€æŠ½å±œå››ï¼šæ’°å¯« IEP(1)ã€‚\n\nä½†è¼ƒå¸¸è¦‹çš„å¯¦å‹™æµç¨‹æ˜¯ï¼š\n1ï¸âƒ£ åŠŸèƒ½æ€§è©•é‡èˆ‡äº†è§£éœ€æ±‚ï¼ˆå°æ‡‰æ•¸å­— 3ï¼‰\n2ï¸âƒ£ æ’°å¯« IEPï¼ˆå°æ‡‰æ•¸å­— 1ï¼‰\n3ï¸âƒ£ å¯¦æ–½æ•™å­¸èª¿æ•´èˆ‡è¼”å…·æ”¯æ´ï¼ˆå°æ‡‰æ•¸å­— 4ï¼‰\n4ï¸âƒ£ å®¶é•·èˆ‡è·¨å°ˆæ¥­åœ˜éšŠåˆä½œæœƒè­°ï¼ˆå°æ‡‰æ•¸å­— 7ï¼‰\n\næ‰€ä»¥è¦å…ˆæƒ³åˆ°æ­£ç¢ºæµç¨‹ï¼Œå†æŠŠå°æ‡‰çš„æ•¸å­—ä¾åºè®€å‡ºï¼š3-1-4-7ï¼Œä¹Ÿå°±æ˜¯å¤§é–€å¯†ç¢¼çš„ç¬¬ä¸€æ®µã€Œ3147ã€ã€‚"
      },
      {
        id: 2,
        name: "æ•™å®¤ Bï¼ˆæ„Ÿå®˜èˆ‡æ³¨æ„åŠ›æ”¯æŒï¼‰",
        type: "code",
        title: "æ•™å®¤ Bï¼šæ„Ÿå®˜æç¤ºç‡ˆèˆ‡æ•™å®¤è¦å‰‡",
        question:
          "æ•™å®¤ B æ˜¯å¯¦ä½œã€Œç­ç´šç¶“ç‡Ÿèˆ‡æƒ…ç·’/æ³¨æ„åŠ›æ”¯æŒç­–ç•¥ã€çš„åœ°æ–¹ã€‚\n\né»‘æ¿ä¸Šæ–¹æœ‰ä¸‰å€‹é•·æ¢ç‡ˆï¼Œè€å¸«è¨­è¨ˆäº†ä¸€å¥—ç°¡å–®çš„è¦–è¦ºæç¤ºï¼Œè®“æ³¨æ„åŠ›è¼ƒæ˜“åˆ†æ•£ã€æˆ–å°è²éŸ³æ•æ„Ÿçš„å­¸ç”Ÿï¼Œä¹Ÿèƒ½å¿«é€ŸçŸ¥é“ç¾åœ¨èª²å ‚æ¨¡å¼ï¼š\n\näº®ç‡ˆï¼šå¯ä»¥å°è²è¨è«–æˆ–æ´»å‹•ï¼ˆç”¨ 1 è¡¨ç¤ºï¼‰\næš—ç‡ˆï¼šéœ€è¦å®‰éœé–±è®€æˆ–å°ˆå¿ƒè½è¬›ï¼ˆç”¨ 0 è¡¨ç¤ºï¼‰\n\næ­¤åˆ»ç‡ˆçš„ç‹€æ…‹æ˜¯ï¼š\n\näº®ã€€ï½œã€€æš—ã€€ï½œã€€äº®\n\næ¡Œä¸Šçš„æç¤ºå¡å¯«è‘—ï¼šã€Œè«‹æŠŠç‡ˆè™Ÿçœ‹æˆä¸€å€‹ä¸‰ä½æ•¸çš„äºŒé€²ä½æ•¸ï¼Œå†æ›æˆåé€²ä½ï¼Œå¾—åˆ°å¤§é–€å¯†ç¢¼çš„ç¬¬äºŒæ®µã€‚ã€\n\nè«‹è¼¸å…¥æ›ç®—å¾Œçš„åé€²ä½æ•¸å­—ã€‚",
        hint: "å¾å·¦åˆ°å³æ˜¯ 1â€†0â€†1ï¼ˆäºŒé€²ä½ 101ï¼‰ï¼Œè©¦è‘—ç®—ç®—ï¼š4 çš„ä½ + 1 çš„ä½ã€‚",
        answer: "5",
        explanation:
          "ä¾æç¤ºï¼Œäº® = 1ã€æš— = 0ï¼Œæ‰€ä»¥ä¸‰æ ¼ç‡ˆä¾åºæ˜¯ 1â€†0â€†1ï¼Œå°±æ˜¯äºŒé€²ä½çš„ 101ã€‚\nå°‡ 101â‚‚ æ›æˆåé€²ä½ç‚º 5ï¼ˆ4 + 1ï¼‰ã€‚å› æ­¤é€™ä¸€é—œçš„å¤§é–€å¯†ç¢¼ç¬¬äºŒæ®µæ˜¯ã€Œ5ã€ã€‚\n\né€™æ¨£çš„è¦–è¦ºæç¤ºç³»çµ±å¯ä»¥æ­é…å£é ­èªªæ˜ã€åº§ä½å®‰æ’èˆ‡å…¶ä»–èª¿æ•´ï¼Œå”åŠ© ADHDã€è‡ªé–‰ç—‡æˆ–å®¹æ˜“ç„¦æ…®çš„å­¸ç”Ÿæ›´å¿«æŒæ¡æ•™å®¤ç‹€æ…‹ï¼Œæ˜¯ç‰¹æ•™ç³»å¸¸æœƒå­¸åˆ°çš„ç’°å¢ƒèª¿æ•´ç­–ç•¥ã€‚"
      },
      {
        id: 3,
        name: "æ•™å®¤ Cï¼ˆèåˆé«”è‚²èˆ‡åˆç†èª¿æ•´ï¼‰",
        type: "code",
        title: "æ•™å®¤ Cï¼šèåˆé«”è‚²èª²çš„å™¨æé…ç½®",
        question:
          "æ•™å®¤ C æ¨¡æ“¬çš„æ˜¯é«”è‚²å™¨æé–“ï¼Œç‰†ä¸Šè²¼è‘—ä¸€å¼µã€Œèåˆé«”è‚²èª²å™¨æé…ç½®ç¤ºæ„ã€ï¼Œå¸Œæœ›èº«å¿ƒéšœç¤™å­¸ç”Ÿä¹Ÿèƒ½ä¸€èµ·åƒèˆ‡ã€‚\n\nåœ°æ¿ä¸‰å€‹åœ“å½¢æ¨™èªŒå‰ï¼Œåˆ†åˆ¥æ“ºè‘—ä¸åŒå™¨æèˆ‡èªªæ˜ï¼š\n\n2ï¼šé‡é‡è¼ƒè¼•ã€å½ˆæ€§è¼ƒå¥½çš„è»Ÿå¼çƒâ€”â€”é©åˆè‚ŒåŠ›è¼ƒå¼±æˆ–å‹•ä½œå”èª¿è¼ƒæ…¢çš„å­¸ç”Ÿ\n5ï¼šæœƒç™¼å‡ºè²éŸ³çš„çƒâ€”â€”é©åˆè¦–éšœå­¸ç”Ÿé€éè²éŸ³è¿½è¹¤ä½ç½®\n9ï¼šå¤§é¢ç©æ¥çƒæ¿æˆ–å¸ƒå¹•â€”â€”è®“å®³æ€•å¤±èª¤çš„å­¸ç”Ÿä¹Ÿæ¯”è¼ƒå®¹æ˜“æ¥åˆ°çƒ\n\næ—é‚Šçš„ç®­é ­æ¨™ç¤ºé †åºç‚ºï¼š\n\n2 â†’ 5 â†’ 9\n\nèªªæ˜å¡å¯«è‘—ï¼šã€Œè«‹ä¾ç®­é ­é †åºè®€å‡ºå™¨æç·¨è™Ÿï¼ŒæŠŠæ•¸å­—æ¥åœ¨ä¸€èµ·ï¼Œå°±æ˜¯å¤§é–€å¯†ç¢¼çš„ç¬¬ä¸‰æ®µã€‚ã€\n\nè«‹è¼¸å…¥ä½ å¾—åˆ°çš„ä¸‰ä½æ•¸å¯†ç¢¼ã€‚",
        hint: "ç…§ç®­é ­å¾å·¦åˆ°å³è®€ï¼š2ã€5ã€9ï¼Œç›´æ¥æ¥æˆä¸€å€‹ä¸‰ä½æ•¸ã€‚",
        answer: "259",
        explanation:
          "æ ¹æ“šç®­é ­é †åºä¾åºè®€å‡ºæ•¸å­— 2ã€5ã€9ï¼Œæ¥åœ¨ä¸€èµ·å°±æ˜¯ä¸‰ä½æ•¸ã€Œ259ã€ï¼Œä¹Ÿå°±æ˜¯å¤§é–€å¯†ç¢¼çš„ç¬¬ä¸‰æ®µã€‚\n\né€™ä¸€é—œåæ˜ çš„æ˜¯ã€åˆç†èª¿æ•´ã€èˆ‡ã€èåˆé«”è‚²ã€çš„æ¦‚å¿µï¼šé€éæ”¹è®Šå™¨æé‡é‡ã€å¤§å°ã€è²éŸ³ç·šç´¢ç­‰æ–¹å¼ï¼Œè®“ä¸åŒèƒ½åŠ›èˆ‡éœ€æ±‚çš„å­¸ç”Ÿéƒ½èƒ½æœ‰åƒèˆ‡æ„Ÿï¼Œè€Œä¸æ˜¯è¢«æ’é™¤åœ¨æ´»å‹•ä¹‹å¤–ã€‚"
      },
      {
        id: 4,
        name: "è¾¦å…¬å®¤ï¼ˆå¤§é–€è§£é–ï¼‰",
        type: "code",
        title: "è¾¦å…¬å®¤ï¼šè¼¸å…¥ç‰¹æ•™ç³»å¤§é–€å¯†ç¢¼",
        question:
          "ä½ å€‘å¸¶è‘—ä¸‰æ®µå¯†ç¢¼å›åˆ°ç‰¹æ•™ç³»è¾¦å…¬å®¤ï¼Œå¤§é–€æ—é‚Šè£è‘—ä¸€å€‹é›»å­å¯†ç¢¼é–ï¼Œç‰†ä¸Šè²¼è‘—ä¸€å¼µç´™æ¢ï¼š\nã€Œæƒ³è¦é›¢é–‹ç³»é¤¨ï¼Œè«‹ä¾ç…§å–å¾—çš„é †åºï¼Œå°‡ä¸‰æ®µå¯†ç¢¼ç›´æ¥æ¥åœ¨ä¸€èµ·ï¼Œçµ„æˆå®Œæ•´çš„å¤§é–€å¯†ç¢¼ã€‚ã€\n\nå·²çŸ¥ä½ å€‘æ‹¿åˆ°çš„ä¸‰æ®µå¯†ç¢¼æ˜¯ï¼š\nç¬¬ä¸€æ®µï¼š3147ï¼ˆåæ˜ ç‰¹æ•™å¯¦å‹™æµç¨‹ï¼šè©•é‡â†’IEPâ†’æ•™å­¸èª¿æ•´â†’åˆä½œï¼‰\nç¬¬äºŒæ®µï¼š5ï¼ˆä»£è¡¨ä»¥æ„Ÿå®˜èˆ‡ç’°å¢ƒèª¿æ•´æ”¯æŒå­¸ç”Ÿå°ˆæ³¨ï¼‰\nç¬¬ä¸‰æ®µï¼š259ï¼ˆè±¡å¾µåœ¨é«”è‚²èª²ä¸­æä¾›ä¸åŒå™¨æèˆ‡åˆç†èª¿æ•´ï¼‰\n\nè«‹æŠŠä¸‰æ®µå¯†ç¢¼ä¾é †åºæ¥åœ¨ä¸€èµ·ï¼Œè¼¸å…¥å…«ä½æ•¸çš„å¤§é–€å¯†ç¢¼ã€‚",
        hint: "åªè¦æŠŠ 3147ã€5ã€259 ä¾å–å¾—é †åºç›´æ¥æ¥èµ·ä¾†ï¼Œä¸­é–“ä¸è¦åŠ ä»»ä½•ç¬¦è™Ÿæˆ–ç©ºæ ¼ã€‚",
        answer: "31475259",
        explanation:
          "ä¾ç…§æŒ‡ç¤ºï¼Œå°‡ä¸‰æ®µå¯†ç¢¼ä¾é †åºç›¸é€£ï¼šç¬¬ä¸€æ®µ 3147ã€ç¬¬äºŒæ®µ 5ã€ç¬¬ä¸‰æ®µ 259ï¼Œåˆèµ·ä¾†å°±æ˜¯ã€Œ31475259ã€ã€‚\n\nä½ å€‘æˆåŠŸè§£é–ç‰¹æ•™ç³»å¤§é–€ï¼Œé †åˆ©èµ°å‡ºç³»é¤¨ã€‚å¤§é–€æ—çš„ã€Šèº«å¿ƒéšœç¤™å­¸ç”Ÿæ”¯æŒè—åœ–ã€‹æé†’å¤§å®¶ï¼šå‰›æ‰è’é›†å¯†ç¢¼çš„éç¨‹ï¼Œå…¶å¯¦å°±æ˜¯æŠŠç‰¹æ•™å¯¦å‹™ä¸­çš„é‡è¦è§€å¿µâ€”â€”äº†è§£éœ€æ±‚èˆ‡è©•é‡ã€æ’°å¯« IEPã€æ•™å­¸èª¿æ•´èˆ‡åˆä½œï¼Œä»¥åŠç’°å¢ƒèˆ‡èª²ç¨‹çš„åˆç†èª¿æ•´â€”â€”è®Šæˆå…·é«”çš„è¡Œå‹•ç·´ç¿’ã€‚\n\nå°ç‰¹æ•™ç³»å­¸ç”Ÿä¾†èªªï¼Œé€™ä¸åªæ˜¯æˆåŠŸé€ƒå‡ºç³»é¤¨ï¼Œæ›´æ˜¯å­¸æœƒå¦‚ä½•åœ¨ç¾å¯¦ä¸­æ”¯æŒæ¯ä¸€ä½å­¸ç”Ÿã€‚"
      }
    ];

    const TOTAL_TIME_SEC = 15 * 60;
    let remainingSec = TOTAL_TIME_SEC;
    let timerId = null;
    let currentScene = 0;
    const obtainedCodes = [];

    let playerX = 80;
    let playerY = 80;
    const STEP = 5;

    let moveIntervalId = null;
    let modalIsOpen = false;

    const sceneStartPositions = {
      0: { x: 80, y: 75 },
      1: { x: 80, y: 78 },
      2: { x: 80, y: 78 },
      3: { x: 80, y: 78 },
      4: { x: 80, y: 78 }
    };

    const sceneEls = document.querySelectorAll(".scene");
    const markerEls = document.querySelectorAll(".marker");
    const locationLabel = document.getElementById("locationLabel");
    const codesText = document.getElementById("codesText");
    const timerEl = document.getElementById("timer");
    const successBanner = document.getElementById("successBanner");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalTitle = document.getElementById("modalTitle");
    const questionTextEl = document.getElementById("questionText");
    const hintTextEl = document.getElementById("hintText");
    const answerInput = document.getElementById("answerInput");
    const feedbackBox = document.getElementById("feedbackBox");
    const modalCloseBtn = document.getElementById("modalCloseBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const submitBtn = document.getElementById("submitBtn");
    const nextSceneBtn = document.getElementById("nextSceneBtn");

    const ctrlBtns = document.querySelectorAll(".ctrl-btn");
    const playerEl = document.getElementById("player");

    // çµæŸå¾Œçš„æŒ‰éˆ•
    const stayBtn = document.getElementById("stayBtn");
    const restartBtn = document.getElementById("restartBtn");

    // ä¿¡å°ç›¸é—œ
    const envelopeOverlay = document.getElementById("envelopeOverlay");
    const envelopeCard = document.getElementById("envelopeCard");
    const openLetterBtn = document.getElementById("openLetterBtn");
    let pendingSceneIndex = null;

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }

    function updateTimer() {
      timerEl.textContent = formatTime(remainingSec);
    }

    function startTimer() {
      updateTimer();
      timerId = setInterval(() => {
        remainingSec--;
        if (remainingSec <= 0) {
          remainingSec = 0;
          updateTimer();
          clearInterval(timerId);
          timerId = null;
          handleTimeUp();
        } else {
          updateTimer();
        }
      }, 1000);
    }

    function handleTimeUp() {
      stopMoving();
      hideEnvelope();
      feedbackBox.textContent =
        "æ™‚é–“åˆ°äº†ï¼é€™ä¸€è¼ªæŒ‘æˆ°çµæŸï¼Œå¯ä»¥è«‹è€å¸«æˆ–ä¸»æŒäººä¸€èµ·å›é¡§è§£é¡Œéç¨‹ï¼Œå†é‡æ–°æŒ‘æˆ°ä¸€æ¬¡ã€‚";
      feedbackBox.classList.remove("correct-text");
      feedbackBox.classList.add("wrong-text");
      modalTitle.textContent = "æ™‚é–“åˆ°";
      questionTextEl.textContent =
        "15 åˆ†é˜å·²ç¶“ç”¨å®Œï¼Œå»ºè­°å…ˆæš«åœéŠæˆ²èˆ‡åŒä¼´è¨è«–å“ªä¸€é—œæœ€å¡ï¼Œå†é‡æ–°æŒ‘æˆ°ï¼";
      hintTextEl.textContent = "";
      answerInput.style.display = "none";
      submitBtn.style.display = "none";
      nextSceneBtn.style.display = "none";
      modalBackdrop.classList.add("active");
      modalBackdrop.setAttribute("aria-hidden", "false");
      modalIsOpen = true;

      ctrlBtns.forEach((b) => (b.disabled = true));
    }

    function updateLocationLabel() {
      const data = scenesData[currentScene];
      locationLabel.textContent = data ? data.name : "";
    }

    function updateCodesText() {
      if (!obtainedCodes.length) {
        codesText.textContent = "å°šæœªå–å¾—";
      } else {
        codesText.textContent = obtainedCodes.join("ã€€|ã€€");
      }
    }

    function attachPlayerToScene(sceneIndex) {
      const sceneEl = document.querySelector(`.scene[data-scene="${sceneIndex}"]`);
      if (!sceneEl) return;
      const inner = sceneEl.querySelector(".scene-inner");
      if (!inner) return;
      inner.appendChild(playerEl);
    }

    function setPlayerToSceneStart(sceneIndex) {
      const pos = sceneStartPositions[sceneIndex] || { x: 80, y: 80 };
      playerX = pos.x;
      playerY = pos.y;
      updatePlayerPosition();
    }

    function updatePlayerPosition() {
      playerEl.style.left = playerX + "%";
      playerEl.style.top = playerY + "%";
    }

    function showScene(index) {
      sceneEls.forEach((el) => {
        if (Number(el.dataset.scene) === index) {
          el.classList.add("active");
        } else {
          el.classList.remove("active");
        }
      });
      currentScene = index;
      updateLocationLabel();
      attachPlayerToScene(index);
      setPlayerToSceneStart(index);
      modalIsOpen = false;
    }

    function openPuzzle(sceneIndex) {
      const data = scenesData[sceneIndex];
      if (!data) return;

      modalIsOpen = true;
      modalTitle.textContent = data.title;
      questionTextEl.textContent = data.question;
      hintTextEl.textContent = data.hint || "";
      feedbackBox.textContent = "è«‹ä»”ç´°é–±è®€é¡Œç›®ï¼Œå†è¼¸å…¥ä½ çš„ç­”æ¡ˆã€‚";
      feedbackBox.classList.remove("correct-text", "wrong-text");

      if (data.type === "info") {
        answerInput.style.display = "none";
        submitBtn.textContent = "æˆ‘æº–å‚™å¥½äº†";
      } else {
        answerInput.style.display = "block";
        answerInput.value = "";
        submitBtn.textContent = "æäº¤ç­”æ¡ˆ";
      }

      nextSceneBtn.style.display = "none";
      submitBtn.disabled = false;

      modalBackdrop.classList.add("active");
      modalBackdrop.setAttribute("aria-hidden", "false");
      if (data.type !== "info") answerInput.focus();
    }

    function closeModal() {
      modalBackdrop.classList.remove("active");
      modalBackdrop.setAttribute("aria-hidden", "true");
      modalIsOpen = false;
      answerInput.style.display = "block";
      submitBtn.style.display = "inline-block";
    }

    function markSceneSolved(sceneIndex) {
      markerEls.forEach((m) => {
        if (Number(m.dataset.scene) === sceneIndex) {
          m.classList.add("done");
        }
      });
    }

    function goToNextScene(fromIndex) {
      const nextIndex = fromIndex + 1;
      if (nextIndex >= scenesData.length) {
        successBanner.classList.add("show");
        return;
      }
      showScene(nextIndex);
    }

    function isEnvelopeOpen() {
      return envelopeOverlay.classList.contains("active");
    }

    function showEnvelope(sceneIndex) {
      pendingSceneIndex = sceneIndex;
      envelopeOverlay.classList.add("active");
      envelopeOverlay.setAttribute("aria-hidden", "false");
    }

    function hideEnvelope() {
      envelopeOverlay.classList.remove("active");
      envelopeOverlay.setAttribute("aria-hidden", "true");
    }

    function checkPlayerNearMarker() {
      const sceneEl = document.querySelector(
        `.scene[data-scene="${currentScene}"]`
      );
      if (!sceneEl) return;
      const marker = sceneEl.querySelector(".marker");
      if (!marker) return;

      const playerRect = playerEl.getBoundingClientRect();
      const markerRect = marker.getBoundingClientRect();

      const playerCx = playerRect.left + playerRect.width / 2;
      const playerCy = playerRect.top + playerRect.height / 2;
      const markerCx = markerRect.left + markerRect.width / 2;
      const markerCy = markerRect.top + markerRect.height / 2;

      const dx = playerCx - markerCx;
      const dy = playerCy - markerCy;
      const distance = Math.sqrt(dx * dx + dy * dy);

      const THRESHOLD = 40;

      if (distance <= THRESHOLD && !modalIsOpen && !isEnvelopeOpen()) {
        showEnvelope(currentScene);
      }
    }

    function movePlayer(direction) {
      if (remainingSec <= 0) return;

      if (direction === "up") {
        playerY -= STEP;
      } else if (direction === "down") {
        playerY += STEP;
      } else if (direction === "left") {
        playerX -= STEP;
      } else if (direction === "right") {
        playerX += STEP;
      }

      if (playerX < 10) playerX = 10;
      if (playerX > 90) playerX = 90;
      if (playerY < 12) playerY = 12;
      if (playerY > 88) playerY = 88;

      updatePlayerPosition();
      checkPlayerNearMarker();
    }

    function startMoving(direction) {
      if (remainingSec <= 0) return;
      stopMoving();
      movePlayer(direction);
      moveIntervalId = setInterval(() => {
        if (!modalIsOpen && remainingSec > 0 && !isEnvelopeOpen()) {
          movePlayer(direction);
        }
      }, 120);
    }

    function stopMoving() {
      if (moveIntervalId !== null) {
        clearInterval(moveIntervalId);
        moveIntervalId = null;
      }
    }

    // æ‰‹æ©Ÿæ–¹å‘éµ
    ctrlBtns.forEach((btn) => {
      const dir = btn.dataset.dir;

      btn.addEventListener("click", () => {
        movePlayer(dir);
      });

      btn.addEventListener("mousedown", () => {
        startMoving(dir);
      });
      btn.addEventListener("mouseup", stopMoving);
      btn.addEventListener("mouseleave", stopMoving);

      btn.addEventListener("touchstart", (e) => {
        e.preventDefault();
        startMoving(dir);
      }, { passive: false });

      btn.addEventListener("touchend", stopMoving);
      btn.addEventListener("touchcancel", stopMoving);
    });

    // éµç›¤æ–¹å‘éµ
    window.addEventListener("keydown", (e) => {
      if (remainingSec <= 0) return;
      if (modalIsOpen || isEnvelopeOpen()) return;

      if (e.key === "ArrowUp") movePlayer("up");
      else if (e.key === "ArrowDown") movePlayer("down");
      else if (e.key === "ArrowLeft") movePlayer("left");
      else if (e.key === "ArrowRight") movePlayer("right");
    });

    // ä¿¡å°é»æ“Šï¼šæ‰“é–‹é¡Œç›®
    function openLetterAndPuzzle() {
      hideEnvelope();
      const targetScene = pendingSceneIndex != null ? pendingSceneIndex : currentScene;
      openPuzzle(targetScene);
      pendingSceneIndex = null;
    }

    openLetterBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      openLetterAndPuzzle();
    });

    envelopeCard.addEventListener("click", () => {
      openLetterAndPuzzle();
    });

    envelopeOverlay.addEventListener("click", (e) => {
      // é»ç°è‰²èƒŒæ™¯å°±é—œæ‰ä¿¡å°ï¼Œä¸é–‹é¡Œç›®
      if (e.target === envelopeOverlay) {
        hideEnvelope();
      }
    });

    submitBtn.addEventListener("click", () => {
      const data = scenesData[currentScene];
      if (!data) return;

      if (data.type === "info") {
        feedbackBox.textContent = data.explanation;
        feedbackBox.classList.add("correct-text");
        markSceneSolved(currentScene);
        submitBtn.disabled = true;
        nextSceneBtn.style.display = "inline-block";
        nextSceneBtn.textContent = "å‰å¾€æ•™å®¤ A â–¶";
        return;
      }

      const userAns = (answerInput.value || "").trim();
      if (!userAns) {
        feedbackBox.textContent = "è«‹å…ˆè¼¸å…¥ä½ çš„ç­”æ¡ˆå–”ï¼";
        feedbackBox.classList.remove("correct-text");
        feedbackBox.classList.add("wrong-text");
        return;
      }

      const correct = userAns === String(data.answer).trim();
      if (correct) {
        feedbackBox.innerHTML = "<strong>ç­”å°äº†ï¼ğŸ‘</strong> " + data.explanation;
        feedbackBox.classList.remove("wrong-text");
        feedbackBox.classList.add("correct-text");
        submitBtn.disabled = true;
        nextSceneBtn.style.display = "inline-block";
        if (currentScene < scenesData.length - 1) {
          nextSceneBtn.textContent = "å‰å¾€ä¸‹ä¸€å€‹å ´æ™¯ â–¶";
        } else {
          nextSceneBtn.textContent = "å®ŒæˆéŠæˆ² ğŸ‰";
        }
        markSceneSolved(currentScene);

        if (data.answer && !obtainedCodes.includes(String(data.answer))) {
          obtainedCodes.push(String(data.answer));
          updateCodesText();
        }

        if (currentScene === scenesData.length - 1) {
          successBanner.classList.add("show");
          if (timerId) {
            clearInterval(timerId);
            timerId = null;
          }
        }
      } else {
        feedbackBox.innerHTML =
          "<strong>é‚„å·®ä¸€é»é»ï½</strong> å¯ä»¥å†æƒ³æƒ³çœ‹ç·šç´¢ï¼Œæˆ–å’ŒåŒå­¸ä¸€èµ·è¨è«–ã€‚";
        feedbackBox.classList.remove("correct-text");
        feedbackBox.classList.add("wrong-text");
      }
    });

    nextSceneBtn.addEventListener("click", () => {
      closeModal();
      const prevIndex = currentScene;
      goToNextScene(prevIndex);
    });

    modalCloseBtn.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) closeModal();
    });

    // çµæŸå¾Œï¼šå¾…åœ¨åŸåœ° / é‡æ–°æŒ‘æˆ°
    function restartGame() {
      // é‡è¨­æ™‚é–“
      remainingSec = TOTAL_TIME_SEC;
      if (timerId) {
        clearInterval(timerId);
      }
      startTimer();

      // æ¸…ç©ºå¯†ç¢¼ç´€éŒ„
      obtainedCodes.length = 0;
      updateCodesText();

      // æ¸…é™¤æ‰€æœ‰é©šå˜†è™Ÿå®Œæˆç‹€æ…‹
      markerEls.forEach((m) => m.classList.remove("done"));

      // éš±è—æˆåŠŸè¨Šæ¯
      successBanner.classList.remove("show");

      // å›åˆ°å¤§å»³
      showScene(0);

      // å•Ÿç”¨æ§åˆ¶éµ
      ctrlBtns.forEach((b) => (b.disabled = false));

      // é—œé–‰ä»»ä½•å¯èƒ½é–‹è‘—çš„é¡Œç›®è¦–çª—
      closeModal();
    }

    stayBtn.addEventListener("click", () => {
      // ä»€éº¼éƒ½ä¸ç”¨åšï¼šä¿ç•™æˆåŠŸè¨Šæ¯ã€ä¿æŒç›®å‰å ´æ™¯ï¼Œå¯ä»¥è‡ªç”±èµ°å‹•
      closeModal();
    });

    restartBtn.addEventListener("click", () => {
      restartGame();
    });

    // åˆå§‹åŒ–
    attachPlayerToScene(0);
    setPlayerToSceneStart(0);
    updateLocationLabel();
    updateCodesText();
    startTimer();
  </script>
</body>
</html>

